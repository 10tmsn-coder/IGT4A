<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>IGT4A — Iowa Gambling Task (iPad)</title>
<style>
  :root{
    --bg:#ffffff; --card-back:#0a66ff; --card-shadow:#8c8c8c;
    --green:#28a745; --red:#c9302c; --text:#111;
  }
  html,body{height:100%;margin:0;font-family: "Hiragino Kaku Gothic ProN", "Helvetica Neue", Arial, "ＭＳ ゴシック"; background:var(--bg); color:var(--text);}
  .container{display:flex;flex-direction:column;height:100vh;padding:12px;box-sizing:border-box;gap:8px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;}
  h1{font-size:1.15rem;margin:0;}
  .controls{display:flex;gap:8px;align-items:center;}
  .big{font-size:1.05rem;padding:10px 14px;border-radius:8px;border:1px solid #ddd;background:#f7f7f7;}
  .stage{flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;}
  .intro{max-width:900px;padding:12px;border-radius:10px;border:1px solid #eee;background:#fafafa; font-size:1rem; line-height:1.6;}
  .commentRow{display:flex;gap:8px;align-items:center;width:100%;margin-top:6px;}
  input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:1rem}
  button{padding:10px 12px;border-radius:8px;border:1px solid #bbb;background:white;font-size:1rem;touch-action:manipulation;}
  .gameArea{width:100%;max-width:1100px; display:flex; flex-direction:column; gap:12px; align-items:center;}
  .topRow{display:flex;gap:18px;width:100%;align-items:center;justify-content:space-between;}
  .graphWrap{min-width:260px}
  .label{font-size:1rem;margin-bottom:6px}
  .bar{height:28px;border-radius:6px;background:#eee;position:relative;overflow:hidden}
  .barInner{height:100%;width:0;background:var(--green);transition:width 300ms linear}
  .barDebt{height:100%;width:0;background:var(--red);position:absolute;left:0;top:0;transition:width 300ms linear;opacity:0.9}
  .deckRow{display:flex;gap:16px;align-items:flex-start;justify-content:center;width:100%;padding:6px;flex-wrap:wrap;margin-top:30px;}
  .card{width:180px;height:260px;border-radius:8px;box-shadow:4px 6px 0 var(--card-shadow);display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--card-back);touch-action:manipulation;overflow:hidden}
  .card img{width:100%;height:100%;object-fit:cover;display:block}
  .cardLabel{margin-top:8px;font-size:1.2rem;font-weight:700;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,0.4)}
  .prompt{font-size:1.2rem;padding:8px 12px;border-radius:6px;background:#fff;border:1px solid #eee}
  .feedback{min-height:48px;font-size:1.2rem;text-align:center}
  .facesvg{width:64px;height:64px}
  footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:6px}
  .small{font-size:0.9rem}
  .topRow {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 16px;
  }
  .feedback {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: auto;
  }
  .facesvg {
    width: 64px;
    height: 64px;
  }

  @media (max-width:600px){
    .card{width:150px;height:220px}
    .cardLabel{font-size:1.1rem}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>IGT4A — Iowa Gambling Task</h1>
    <div class="controls">
      <button id="startBtn" class="big">実験を開始</button>
    </div>
  </header>

  <main class="stage">
    <div id="intro" class="intro">
      <div><strong>備考（氏名・実験条件など）を入力してください：</strong></div>
      <div class="commentRow">
        <input id="comment" type="text" placeholder="例：被験者ID_01 / 条件A" />
        <button id="saveComment">保存</button>
      </div>
      <hr />
      <div>
        <strong>ご参加ありがとうございます。</strong>
        <ol>
          <li>今からゲームを始めるために、20万円をあなたにお貸しします。このゲームの目標は、今貸した20万円を返し、さらに出来るだけ手元にあるお金を多くすることです。終了するまで、出来るだけ多くのお金を獲得し、出来るだけお金を失わないようにしてください。ゲームがいつ終わるかは分かりません。</li>
          <li>カードを選ぶたびに、選択したカードに応じてお金を獲得できます。しかし、カードを選択した際にお金を没収されることもあります。カードを引くたびに、左上の「手持額」「借金額」バーが更新されます。</li>
          <li>あなたへ一つヒントを教えます。4組のデッキには、お金を増やすために有利なものと不利なものがあります。手元のお金をより多くするためには、不利なデッキからカードを選ばないようにしなければなりません。また、どんなにお金を失っても、不利なデッキを避ければお金を取り戻すことが可能です。</li>
　　　　　<li>準備ができた方は、実験を開始してください。何か質問があれば、実験者を呼び、今尋ねてください。</li>

        </ol>
      </div>
    </div>

    <div id="game" class="gameArea" style="display:none">
      <div class="topRow">
        <div class="graphWrap">
          <div class="label">手持額（緑） / 借金（赤）</div>
          <div style="display:flex;gap:6px;align-items:center;">
      <div style="width:220px">
        <div class="bar" aria-hidden>
          <div id="cashBar" class="barInner"></div>
          <div id="debtBar" class="barDebt"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.95rem;margin-top:4px;">
          <div id="cashLabel">200,000円</div>
          <div id="debtLabel">借金: 200,000円</div>
        </div>
      </div>

      <div style="min-width:160px">
        <div class="label">〇デッキを選んでください。</div>
        <div id="promptBox" class="prompt">
          画面のデッキをタップしてカードを選んでください。
        </div>
      </div>

    </div>
  </div>

      <div id="faceContainer"></div>
    <div id="feedback" class="feedback"></div>

  </div> <!-- ← ここで topRow を確実に閉じる -->

  <div class="deckRow" id="decks"></div>

  <div style="display:flex;gap:16px;width:100%;justify-content:center;align-items:center;">

        <div>
          <button id="forceDownload" style="display:none">CSVをダウンロード</button>
        </div>
      </div>

    </div>
  </main>

 
</div>

<script>
/* IGT4A — Browser (image-mode, trial count hidden)
   - 初期金額: 200,000円（内部: BorrowInit = 2000ドル ×100 → 表示200,000円）
   - 画像あり版: デッキ画像 (deckA.jpg ... deckD.jpg) を使用可能（同フォルダ配置推奨）
   - 試行数は内部で100だが画面には表示しない
*/

// ---------- Parameters ----------
const nTrial = 100;
const nDeck = 4;
const nCard = 40;
const BorrowInit = 2000; // dollars; displayed as *100 => yen
const Win = [100, 100, 50, 50]; // per-deck win (dollars)
const TrialDelay = 50;
const SelDelay = 100;
const RewardDelay = 2000;
const PenaltyDelay = 2000;
const InterMess = 100;

// ---------- Lose arrays (copied from HSP) ----------
const Lose = [
  [0,0,150,0,300,0,200,0,250,350,0,350,0,250,200,0,300,150,0,0,0,300,0,350,0,200,250,150,0,0,350,200,250,0,0,0,150,300,0,0],
  [-1,-1,0,-1,0,-1,0,0,1250,0,-1,-1,0,1250,0,-1,-1,0,0,0,1250,0,-1,0,-1,0,0,0,-1,1250,0,-1,0,-1,0,-1,0,-1,0,0],
  [0,0,50,0,50,0,50,0,50,50,0,25,75,0,0,0,25,75,0,50,0,0,0,50,25,50,0,0,75,50,0,0,0,25,25,0,75,0,50,75],
  [-1,0,-1,0,0,-1,-1,0,0,250,-1,-1,0,0,-1,0,0,0,-1,250,0,-1,0,0,-1,-1,-1,0,250,0,0,-1,0,-1,250,-1,0,0,-1,0]
];
for(let d=0; d<nDeck; d++){
  while(Lose[d].length < nCard) Lose[d].push(0);
  Lose[d].length = nCard;
}

// ---------- State ----------
let deckPos = Array(nDeck).fill(-1);
let DeckName = ["A","B","C","D"];
let DeckChoice = Array(nTrial).fill("X");
let Reward = Array(nTrial).fill(0);
let Penalty = Array(nTrial).fill(0);
let Net = Array(nTrial).fill(0);
let Total = Array(nTrial).fill(0);
let Debt = Array(nTrial).fill(0);
let RT = Array(nTrial).fill(0);

let iTotal, GCash, Borrow, MoreBorrow;
let iTrial = 0;
let waitingForStart = true;
let commentSaved = "";
let audioEnabled = false;

// ---------- DOM ----------
const startBtn = document.getElementById("startBtn");
const intro = document.getElementById("intro");
const game = document.getElementById("game");
const decksDiv = document.getElementById("decks");
const promptBox = document.getElementById("promptBox");
const feedbackDiv = document.getElementById("feedback");
const faceContainer = document.getElementById("faceContainer");
const cashBar = document.getElementById("cashBar");
const debtBar = document.getElementById("debtBar");
const cashLabel = document.getElementById("cashLabel");
const debtLabel = document.getElementById("debtLabel");
const commentInput = document.getElementById("comment");
const saveCommentBtn = document.getElementById("saveComment");
const forceDownloadBtn = document.getElementById("forceDownload");

// ---------- WebAudio ----------
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playTone(freq=880, dur=0.12){
  ensureAudio();
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
  g.gain.value=0.0001; o.start();
  g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
  o.stop(audioCtx.currentTime + dur + 0.02);
}

// ---------- Face SVGs ----------
const happyFaceSVG = `<svg class="facesvg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#ffeb99" stroke="#333"/><circle cx="35" cy="40" r="6"/><circle cx="65" cy="40" r="6"/><path d="M30 60 Q50 78 70 60" stroke="#333" stroke-width="4" fill="none" stroke-linecap="round"/></svg>`;
const sadFaceSVG   = `<svg class="facesvg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#ffd6d6" stroke="#333"/><circle cx="35" cy="40" r="6"/><circle cx="65" cy="40" r="6"/><path d="M30 70 Q50 52 70 70" stroke="#333" stroke-width="4" fill="none" stroke-linecap="round"/></svg>`;

// ---------- Helpers ----------
function dollarToYenString(dollar){
  const amount = Math.round(dollar * 100);
  return amount.toLocaleString() + "円";
}
function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

// ---------- UI: create deck elements with images ----------
function createDeckElements(){
  decksDiv.innerHTML = "";
  // image filenames: deckA.jpg, deckB.jpg, deckC.jpg, deckD.jpg (you can replace with jpg)
const filenames = ["img/deckA.jpg","img/deckB.jpg","img/deckC.jpg","img/deckD.jpg"];
  for(let d=0; d<nDeck; d++){
    const wrapper = document.createElement("div");
    wrapper.style.display="flex";
    wrapper.style.flexDirection="column";
    wrapper.style.alignItems="center";
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.deck = d;

    // try to show image; if missing, fallback to colored back with label
    const img = document.createElement("img");
    img.alt = "Deck " + DeckName[d];
    img.src = filenames[d];
    img.onerror = function(){
      // fallback: use label-only visual
      img.style.display = "none";
      card.style.background = "linear-gradient(180deg,#0a66ff,#0753d6)";
      const label = document.createElement("div");
      label.className = "cardLabel";
      label.textContent = DeckName[d];
      card.appendChild(label);
    };
    card.appendChild(img);
    wrapper.appendChild(card);
    decksDiv.appendChild(wrapper);

    // event listeners
    const handler = (e)=>{
      e.preventDefault();
      if(!audioEnabled){
        try{ ensureAudio(); audioCtx.resume && audioCtx.resume(); }catch(e){}
        audioEnabled = true;
      }
      if(!waitingForStart) deckClicked(d);
    };
    card.addEventListener("click", handler);
    card.addEventListener("touchend", (ev)=>{ ev.preventDefault(); handler(ev); });
  }
}

// ---------- Bars ----------
function updateBars(){
  GCash = iTotal + (MoreBorrow * BorrowInit);
  const yen = Math.round(GCash * 100);
  const debtYen = Math.round(Borrow * 100);
  const scaleMaxYen = 800000;
  const cashW = Math.min(1, Math.max(0, yen / scaleMaxYen)) * 100;
  const debtW = Math.min(1, Math.max(0, debtYen / scaleMaxYen)) * 100;
  cashBar.style.width = cashW + "%";
  debtBar.style.width = debtW + "%";
  cashLabel.textContent = dollarToYenString(GCash);
  debtLabel.textContent = "借金: " + dollarToYenString(Borrow);
}

// ---------- Experiment control ----------
let rtStart = 0;
function startExperiment(){
  iTotal = BorrowInit;
  GCash = iTotal;
  Borrow = BorrowInit;
  MoreBorrow = 0;
  waitingForStart = false;
  iTrial = 0;
  deckPos = Array(nDeck).fill(-1);
  DeckChoice.fill("X");
  Reward.fill(0); Penalty.fill(0); Net.fill(0); Total.fill(0); Debt.fill(0); RT.fill(0);
  intro.style.display="none";
  game.style.display="block";
  createDeckElements();
  updateBars();
  promptBox.textContent = "画面のデッキをタップしてカードを選んでください。";
  feedbackDiv.innerHTML = "";
  faceContainer.innerHTML = "";
  forceDownloadBtn.style.display = "none";
}

async function deckClicked(jDeck){
  if(iTrial >= nTrial) return;
  rtStart = performance.now();
  promptBox.textContent = "あなたが選んだデッキ： " + DeckName[jDeck] + " ";
  await sleep(SelDelay);

  // update deck position
  deckPos[jDeck] = (deckPos[jDeck] + 1) % nCard;

  let iReward = Win[jDeck];
  let iPenalty = Lose[jDeck][deckPos[jDeck]];
  let cardColor = "black";
  if(iPenalty === -1){
    iPenalty = 0;
    cardColor = "red";
  }
  const iNet = iReward - iPenalty;
  iTotal += iNet;
  GCash = iTotal + (MoreBorrow * BorrowInit);
  if(GCash < 0){
    Borrow += BorrowInit;
    MoreBorrow += 1;
    GCash += BorrowInit;
  }

  // save trial data
  const idx = iTrial;
  DeckChoice[idx] = DeckName[jDeck];
  Reward[idx] = iReward;
  Penalty[idx] = iPenalty;
  Net[idx] = iNet;
  Total[idx] = GCash;
  Debt[idx] = Borrow;

  const rtStop = performance.now();
  RT[idx] = Math.round(rtStop - rtStart);
  iTrial += 1;

  // show reward feedback
  feedbackDiv.innerHTML = `<div style="color:var(--green);font-weight:600">${(iReward*100).toLocaleString()}円を獲得しました。</div>`;
  faceContainer.innerHTML = happyFaceSVG;
  try{ playTone(880,0.12); }catch(e){}
  updateBars();
  await sleep(RewardDelay + InterMess);

  // penalty feedback if exists
  if(iPenalty !== 0){
    feedbackDiv.innerHTML = `<div style="color:var(--red);font-weight:600">しかし，また ${(iPenalty*100).toLocaleString()}円を失いました。</div>`;
    faceContainer.innerHTML = sadFaceSVG;
    try{ playTone(220,0.18); }catch(e){}
    updateBars();
    await sleep(PenaltyDelay);
  }

  feedbackDiv.innerHTML = "";
  faceContainer.innerHTML = "";
  await sleep(TrialDelay);

  if(iTrial >= nTrial) endExperiment();
}

// ---------- End & CSV ----------
function endExperiment(){
  waitingForStart = true;
  promptBox.textContent = "実験終了。CSVをダウンロードしてください。";
  const payback = GCash - Borrow;
  const payYen = dollarToYenString(payback);
  if(payback > 0){
    feedbackDiv.innerHTML = `<div style="font-weight:700">正味の獲得額：${payYen}</div><div>借りを返した後の正味の獲得額は ${payYen} です。</div>`;
  } else {
    feedbackDiv.innerHTML = `<div style="font-weight:700">正味の損失額：${payYen}</div><div>借りを返した後の正味の損失額は ${payYen} です。</div>`;
  }
  prepareCSV();
  forceDownloadBtn.style.display = "inline-block";
}

function prepareCSV(){
  let csv = "";
  csv += "# " + (commentSaved || "") + "\n";
  csv += "Trial,Deck,Reward,Penalty,Net,Total,Debt,RT\n";
  for(let t=0;t<nTrial;t++){
    csv += [t+1, DeckChoice[t], Reward[t], Penalty[t], Net[t], Total[t], Debt[t], RT[t]].join(",") + "\n";
  }
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  forceDownloadBtn.onclick = ()=>{
    const now=new Date();
    const mm=String(now.getMonth()+1).padStart(2,'0');
    const dd=String(now.getDate()).padStart(2,'0');
    const hh=String(now.getHours()).padStart(2,'0');
    const mi=String(now.getMinutes()).padStart(2,'0');
    const ss=String(now.getSeconds()).padStart(2,'0');
    const filename = `IGT_v4A_${mm}${dd}${hh}${mi}${ss}.csv`;
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),30000);
  };
}

// ---------- Handlers ----------
startBtn.addEventListener("click", ()=>{
  if(!audioEnabled){ try{ ensureAudio(); audioCtx.resume && audioCtx.resume(); }catch(e){} audioEnabled=true; }
  startExperiment();
});
saveCommentBtn.addEventListener("click", ()=>{
  commentSaved = commentInput.value.trim();
  alert("備考を保存しました: " + (commentSaved || "(未入力)"));
});
forceDownloadBtn.addEventListener("click", ()=>{ forceDownloadBtn.onclick && forceDownloadBtn.onclick(); });

// initialize (hidden until start)
createDeckElements();
</script>
</body>
</html>


